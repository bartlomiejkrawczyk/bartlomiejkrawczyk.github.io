---
import { getCollection, render } from "astro:content";
import Prose from "@components/markdown/Prose.astro";
import Layout from "@layouts/Layout.astro";
import TagElement from "@components/content/TagElement.astro";
import { tags as allTags } from "@components/content/Tags";
import dayjs from "dayjs";
import utc from "dayjs/plugin/utc";
import type { ExtendedProjectEntry } from "@src/content.config";
import { getTranslations } from "@src/i18n/ui";
import Icon from "@src/components/Icon.astro";

dayjs.extend(utc);

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects
    .sort((a, b) => a.id.localeCompare(b.id))
    .map((project) => ({
      params: { project: project.id },
      props: { project },
    }));
}

interface Props {
  project: ExtendedProjectEntry;
}

const { project } = Astro.props;
const { Content, remarkPluginFrontmatter } = await render(project);

const { data } = project;

const lastModified = dayjs(remarkPluginFrontmatter.lastModified).format(
  "YYYY-MM-DD HH:mm",
);

const projectTags =
  data.tags?.map((tagId) => allTags[tagId]).filter(Boolean) ?? [];

const lang = Astro.currentLocale;
const t = getTranslations(lang);

const printHeaderClass =
  data.printHeader === undefined || data.printHeader ? "" : "no-print";
---

<Layout title={data.title ?? "Project"}>
  <Fragment slot="head">
    <script
      async
      is:inline
      src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
    ></script>
    <script is:inline>
      window.MathJax = {
        tex: {
          inlineMath: [
            ["$", "$"],
            ["\\(", "\\)"],
          ],
        },
        svg: {
          fontCache: "global",
        },
      };
    </script>
  </Fragment>

  <div class={`mb-6 ${printHeaderClass}`}>
    {
      data.title && (
        <h1 class="font-bold mb-4" style="font-size: var(--text-5xl);">
          <b>{data.title}</b>
        </h1>
      )
    }
    <div class="flex flex-col md:flex-row md:items-center gap-2 w-full">
      {
        data.description && (
          <p class="text-left" style="font-size: var(--text-lg)">
            {data.description}
          </p>
        )
      }
      <ul class="flex flex-wrap gap-1.5">
        {projectTags.map((tag) => <TagElement tag={tag} class="tag-style" />)}
      </ul>
    </div>

    <div class="mt-2 text-sm flex flex-row items-center gap-4">
      <span class="flex flex-row items-center gap-1">
        <div>
          <Icon icon="pencil" gradient={true} size="1.5rem" />
        </div>
        <div style="color: var(--primary-dark)">
          {lastModified}
        </div>
      </span>
      {
        remarkPluginFrontmatter.minutesRead && (
          <span class="flex flex-row items-center gap-1">
            <div>
              <Icon icon="book" gradient={true} size="1.5rem" />
            </div>
            <div style="color: var(--primary-dark)">
              {remarkPluginFrontmatter.minutesRead.replace(
                "read",
                t.markdown.read,
              )}
            </div>
          </span>
        )
      }
      {
        data.repository && (
          <a
            href={data.repository}
            target="_blank"
            class="flex flex-row items-center gap-1"
          >
            <Icon icon="git-fork" gradient={true} size="1.5rem" />
            {data.repositoryName ?? "Repository"}
          </a>
        )
      }
      {
        data.externalUrl && (
          <a
            href={data.externalUrl}
            target="_blank"
            class="flex flex-row items-center gap-1"
          >
            <Icon icon="globe" gradient={true} size="1.5rem" />
            {data.externalUrlName ?? "Visit"}
          </a>
        )
      }
    </div>

    <div class="mt-2 flex gap-4"></div>

    {
      data.image && (
        <img
          src={data.image.src}
          alt={data.imageAlt ?? data.title ?? "Project image"}
          class="mt-4 rounded-lg shadow-md max-w-full"
        />
      )
    }

    {
      data.img && (
        <img
          src={data.img}
          alt={data.imgAlt ?? data.title ?? "Project image"}
          class="mt-4 rounded-lg shadow-md max-w-full"
        />
      )
    }
  </div>

  <Prose>
    <Content />
  </Prose>
</Layout>

<style>
  .tag-style {
    font-size: var(--text-sm);
    padding-left: calc(3 * var(--spacing));
    padding-right: calc(3 * var(--spacing));
    padding-top: calc(0.5 * var(--spacing));
    padding-bottom: calc(0.5 * var(--spacing));
    border-radius: 1rem;
  }
</style>
