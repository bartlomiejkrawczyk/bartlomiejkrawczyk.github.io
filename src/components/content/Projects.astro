---
import { getCollection } from "astro:content";
import { getTranslations, type LanguageKey } from "@i18n/ui";
import type { HTMLAttributes } from "astro/types";
import ProjectElement from "./ProjectElement.astro";

const projects = await getCollection("projects").then((projects) =>
  projects.sort((a, b) => a.id.localeCompare(b.id)),
);

const lang = Astro.currentLocale as LanguageKey;

interface Props extends HTMLAttributes<"div"> {}

const { ...props } = Astro.props;

const t = getTranslations(lang);
---

<div {...props}>
  <h2 id="projects" class="pb-1 break-after-avoid">{t.projects.header}</h2>
  <!-- https://docs.astro.build/en/guides/content-collections/#filtering-collection-queries -->
  <ul class="projects-ul">
    {
      Object.entries(projects)
        .filter(([, project]) => {
          return project.data.print ?? false;
        })
        .map(([, project]) => <ProjectElement project={project} />)
    }
    {
      Object.entries(projects)
        .filter(([, project]) => !(project.data.print ?? false))
        .map(([, project]) => <ProjectElement project={project} />)
    }
  </ul>

  <a
    href="https://bartlomiejkrawczyk.github.io/projects-page"
    class="only-print">More Projects</a
  >
</div>

<style>
  .projects-ul {
    display: grid;
    gap: calc(4 * var(--spacing));
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    grid-auto-rows: auto;
    grid-auto-flow: dense;

    margin: 0;
    padding: 0;
    list-style: none;
  }
</style>

<script>
  document.querySelectorAll<HTMLDivElement>(".projects-li").forEach((li) => {
    const backgroundArea = li.querySelector(
      ".project-wrapper",
    ) as HTMLDivElement;
    const link = backgroundArea?.querySelector<HTMLAnchorElement>(".full-link");

    if (!backgroundArea || !link) return;

    backgroundArea.addEventListener("click", (ev) => {
      // Prevent clicks on interactive children from triggering navigation
      const interactiveSelectors = "a, button, input";
      if ((ev.target as HTMLElement).closest(interactiveSelectors)) return;

      // Navigate to the link
      window.location.href = link.href;
    });
  });
</script>

<script>
  // ================================
  // Project Edit Mode (Independent)
  // ================================

  const PROJECT_MODE_KEY = "projectEditMode";
  const PROJECT_HIDDEN_KEY = "hiddenProjects";

  // ----------------------------
  // Load/save edit mode
  // ----------------------------
  function loadProjectEditMode() {
    return localStorage.getItem(PROJECT_MODE_KEY) === "true";
  }

  function saveProjectEditMode(enabled: boolean) {
    localStorage.setItem(PROJECT_MODE_KEY, enabled ? "true" : "false");
  }

  // ----------------------------
  // Load/save hidden projects
  // ----------------------------
  function loadHiddenProjects(): Set<string> {
    try {
      const raw = localStorage.getItem(PROJECT_HIDDEN_KEY);
      if (!raw) return new Set();
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return new Set();
      return new Set(arr.map(String));
    } catch {
      return new Set();
    }
  }

  function saveHiddenProjects(set: Set<string>) {
    try {
      localStorage.setItem(PROJECT_HIDDEN_KEY, JSON.stringify([...set]));
    } catch {}
  }

  // ----------------------------
  // Apply state to DOM
  // ----------------------------
  function applyProjectState() {
    const editMode = loadProjectEditMode();
    const hidden = loadHiddenProjects();

    // Add class to body
    document.body.classList.toggle("project-edit-mode", editMode);

    // Update checkboxes
    document
      .querySelectorAll<HTMLInputElement>("input.project-check")
      .forEach((cb) => {
        const id = cb.dataset.projectId;
        if (!id) return;

        // Show/hide checkbox in edit mode
        cb.classList.toggle("show-in-edit", editMode);

        // Checkbox reflects visibility
        cb.checked = !hidden.has(id);
      });

    // Update each project <li>
    document
      .querySelectorAll<HTMLLIElement>(".projects-li[data-project-id]")
      .forEach((li) => {
        const id = li.dataset.projectId;
        if (!id) return;

        const isHidden = hidden.has(id);

        // Hidden only when NOT in edit mode
        if (!editMode && isHidden) li.classList.add("hidden");
        else li.classList.remove("hidden");
      });

    setupProjectCheckboxListeners();
  }

  // ----------------------------
  // Checkbox handler
  // ----------------------------
  function onProjectCheckboxChange(this: HTMLInputElement) {
    const id = this.dataset.projectId;
    if (!id) return;

    const hidden = loadHiddenProjects();

    if (this.checked) hidden.delete(id);
    else hidden.add(id);

    saveHiddenProjects(hidden);
    applyProjectState();
  }

  function setupProjectCheckboxListeners() {
    document
      .querySelectorAll<HTMLLIElement>("input.project-check")
      .forEach((cb) => {
        cb.removeEventListener(
          "change",
          onProjectCheckboxChange as EventListener,
        );
        cb.addEventListener("change", onProjectCheckboxChange as EventListener);
      });
  }

  // ----------------------------
  // Public API (global)
  // ----------------------------
  (window as any).toggleProjectEditMode = function () {
    const enabled = !loadProjectEditMode();
    saveProjectEditMode(enabled);
    applyProjectState();
  };

  (window as any).enableProjectEditMode = function () {
    saveProjectEditMode(true);
    applyProjectState();
  };

  (window as any).disableProjectEditMode = function () {
    saveProjectEditMode(false);
    applyProjectState();
  };

  (window as any).setProjectVisibility = function (
    id: string,
    visible: boolean,
  ) {
    const hidden = loadHiddenProjects();

    if (visible) hidden.delete(String(id));
    else hidden.add(String(id));

    saveHiddenProjects(hidden);
    applyProjectState();
  };

  (window as any).toggleProject = function (id: string) {
    const hidden = loadHiddenProjects();

    if (hidden.has(String(id))) hidden.delete(String(id));
    else hidden.add(String(id));

    saveHiddenProjects(hidden);
    applyProjectState();
  };

  // ----------------------------
  // Initialize
  // ----------------------------
  window.addEventListener("DOMContentLoaded", applyProjectState);
</script>
