---
import type { HTMLAttributes } from "astro/types";
import type { Tag } from "./Tags";

interface Props extends HTMLAttributes<"li"> {
  tag: Tag;
}

const { tag, ...props } = Astro.props;
---

<style>
  .tag-check {
    display: none;
  }
  .tag-check.show-in-edit {
    display: inline-block;
  }
  li.hidden {
    display: none !important;
  }
</style>

<li
  id={`tag-${tag.id}`}
  class={`skill ${tag.type} ${props.class ?? ""}`}
  data-tag-id={String(tag.id)}
  {...props}
>
  {
    tag.link ? (
      <a href={tag.link} target="_blank" rel="noopener noreferrer">
        {tag.translation.en}
      </a>
    ) : (
      <span>{tag.translation.en}</span>
    )
  }
  <input
    type="checkbox"
    class="tag-check"
    data-tag-id={String(tag.id)}
    aria-label={`Toggle ${tag.translation.en}`}
  />
</li>

<script>
  type ID = string;
  type HiddenSet = Set<ID>;

  const STORAGE_KEY = "hiddenTags";
  const MODE_KEY = "editMode";

  // -------------------------
  // --- Storage helpers -----
  // -------------------------
  function loadHiddenTags(): HiddenSet {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return new Set();
      const arr = JSON.parse(raw);
      if (!Array.isArray(arr)) return new Set();
      return new Set(arr.map((v) => String(v)));
    } catch (e) {
      return new Set();
    }
  }

  function saveHiddenTags(set: HiddenSet): void {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify([...set]));
    } catch (e) {
      // ignore
    }
  }

  function loadTagEditMode(): boolean {
    return localStorage.getItem(MODE_KEY) === "true";
  }

  function saveTagEditMode(enabled: boolean): void {
    try {
      localStorage.setItem(MODE_KEY, enabled ? "true" : "false");
    } catch (e) {
      // ignore
    }
  }

  // -------------------------
  // --- DOM utilities ------
  // -------------------------
  function getListItemById(id: ID): HTMLLIElement | null {
    return document.querySelector<HTMLLIElement>(`li[data-tag-id="${id}"]`);
  }

  function getCheckboxById(id: ID): HTMLInputElement | null {
    return document.querySelector<HTMLInputElement>(
      `input.tag-check[data-tag-id="${id}"]`,
    );
  }

  // -------------------------
  // --- Mode API -----------
  // -------------------------
  (window as any).enableTagEditMode = function enableTagEditMode() {
    setTagEditMode(true);
  };
  (window as any).disableTagEditMode = function disableTagEditMode() {
    setTagEditMode(false);
  };
  (window as any).toggleTagEditMode = function toggleTagEditMode() {
    setTagEditMode(!loadTagEditMode());
  };

  (window as any).setTagEditMode = function setTagEditMode(enabled: boolean) {
    saveTagEditMode(enabled);
    applyHiddenTags();
  };

  // -------------------------
  // --- Tag visibility API -
  // -------------------------
  (window as any).toggleTag = function toggleTag(id: ID) {
    const hidden = loadHiddenTags();
    const sid = String(id);
    if (hidden.has(sid)) hidden.delete(sid);
    else hidden.add(sid);
    saveHiddenTags(hidden);
    applyHiddenTags();
  };

  (window as any).setTagVisibility = function setTagVisibility(
    id: ID,
    visible: boolean,
  ) {
    const hidden = loadHiddenTags();
    const sid = String(id);
    if (visible) hidden.delete(sid);
    else hidden.add(sid);
    saveHiddenTags(hidden);
    applyHiddenTags();
  };

  (window as any).setTagChecked = function setTagChecked(
    id: ID,
    checked: boolean,
  ) {
    (window as any).setTagVisibility(id, checked);
  };

  (window as any).setTagsChecked = function setTagsChecked(
    ids: ID[] | readonly ID[],
    checked: boolean,
  ) {
    const hidden = loadHiddenTags();
    for (const raw of ids) {
      const sid = String(raw);
      if (checked) hidden.delete(sid);
      else hidden.add(sid);
    }
    saveHiddenTags(hidden);
    applyHiddenTags();
  };

  (window as any).hideTags = function hideTags(ids: ID[] | readonly ID[]) {
    (window as any).setTagsChecked(ids, false);
  };

  (window as any).showTags = function showTags(ids: ID[] | readonly ID[]) {
    (window as any).setTagsChecked(ids, true);
  };

  // -------------------------
  // --- Apply state to DOM --
  // -------------------------
  (window as any).applyHiddenTags = function applyHiddenTags() {
    const hidden = loadHiddenTags();
    const editMode = loadTagEditMode();

    document.body.classList.toggle("edit-mode", editMode);

    document
      .querySelectorAll<HTMLInputElement>("input.tag-check")
      .forEach((cb) => {
        const id = String(cb.dataset.tagId ?? "");
        if (!id) return;
        cb.classList.toggle("show-in-edit", editMode);
        cb.checked = !hidden.has(id);
      });

    document
      .querySelectorAll<HTMLLIElement>("li[data-tag-id]")
      .forEach((li) => {
        const id = String(li.dataset.tagId ?? "");
        if (!id) return;
        const isHidden = hidden.has(id);

        if (!editMode && isHidden) li.classList.add("hidden");
        else li.classList.remove("hidden");
      });

    setupCheckboxListeners();
  };

  // -------------------------
  // --- Wire up checkboxes --
  // -------------------------
  function onCheckboxChange(this: HTMLInputElement, e: Event) {
    const cb = this;
    const id = String(cb.dataset.tagId ?? "");
    if (!id) return;
    (window as any).setTagVisibility(id, cb.checked);
  }

  function setupCheckboxListeners() {
    document
      .querySelectorAll<HTMLInputElement>("input.tag-check")
      .forEach((cb) => {
        cb.removeEventListener("change", onCheckboxChange as EventListener);
        cb.addEventListener("change", onCheckboxChange as EventListener);
      });
  }

  // -------------------------
  // --- Init on DOM ready ---
  // -------------------------
  window.addEventListener("DOMContentLoaded", () => {
    applyHiddenTags();
    setupCheckboxListeners();
  });
</script>

<style>
  .skill {
    display: inline-block;
    border-color: var(--gray-900);
    border-style: var(--tw-border-style);
    border-width: 1px;
    border-radius: var(--radius-lg);
    initial-value: solid;
    padding-left: var(--spacing);
    padding-right: var(--spacing);
    font-size: var(--text-sm);
  }
  .skill a {
    color: var(--gray-300);
  }
  .skill a:hover,
  .skill a:focus {
    color: var(--primary-dark);
  }
  .skill.company a:hover,
  .skill.company a:focus,
  .skill.framework a:hover,
  .skill.framework a:focus,
  .skill.tool a:hover,
  .skill.tool a:focus,
  .skill.cloud a:hover,
  .skill.cloud a:focus,
  .skill.database a:hover,
  .skill.database,
  .skill.linguistics a:hover,
  .skill.linguistics a:focus a:focus {
    color: var(--secondary-dark);
  }
  .company {
    background-color: rgb(from var(--secondary-dark) r g b / 25%);
  }
  .language {
    background-color: rgb(from var(--primary-light) r g b / 25%);
  }
  .framework {
    background-color: rgb(from var(--secondary-light) r g b / 25%);
  }
  .technology {
    background-color: rgb(from var(--primary-regular) r g b / 25%);
  }
  .tool {
    background-color: rgb(from var(--secondary-regular) r g b / 25%);
  }
  .operating_system {
    background-color: rgb(from var(--primary-dark) r g b / 25%);
  }
  .cloud {
    background-color: rgb(from var(--secondary-dark) r g b / 25%);
  }
  .library {
    background-color: rgb(from var(--primary-light) r g b / 25%);
  }
  .database {
    background-color: rgb(from var(--secondary-light) r g b / 25%);
  }
  .other {
    background-color: rgb(from var(--primary-regular) r g b / 25%);
  }
  .linguistics {
    background-color: rgb(from var(--secondary-regular) r g b / 25%);
  }
</style>
